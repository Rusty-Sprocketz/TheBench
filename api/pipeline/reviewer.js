const OpenAI = require('openai').default;

const SYSTEM_PROMPT = `You are the Reviewer Agent in a live AI pipeline demo. You review code generated by the Builder against the Architect's spec.

You MUST respond with ONLY valid JSON — no markdown, no explanation, no code fences. Just the raw JSON object.

The JSON must follow this exact schema:
{
  "overallVerdict": "pass" | "fail",
  "score": number (1-10),
  "items": [
    {
      "file": "string — filename",
      "status": "pass" | "warning" | "fail",
      "finding": "string — what was checked/found"
    }
  ],
  "summary": "string — 2-3 sentence overall assessment",
  "reviewerNotes": "string — brief notes about the review process"
}

Review these aspects:
1. Does the implementation match the Architect's API contract?
2. Are all required UI elements present (input, button, output area, build log panel)?
3. Is user input sanitized to prevent XSS?
4. Are there exposed API keys or secrets in frontend code?
5. Does the CSS use the specified theme colors?
6. Is the serverless function properly structured?
7. Does vercel.json have correct routing?
8. Basic accessibility (labels, semantic HTML)

Be thorough but fair. Real issues are warnings/fails. Working code is a pass.`;

module.exports = async (req, res) => {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  if (!process.env.OPENAI_API_KEY) {
    return res.status(500).json({ error: 'OpenAI API key not configured' });
  }

  try {
    const { spec, files } = req.body;

    if (!spec || !files) {
      return res.status(400).json({ error: 'Missing spec or files' });
    }

    const userPrompt = `Review this Builder output against the Architect's spec.

ARCHITECT SPEC:
${JSON.stringify(spec, null, 2)}

BUILDER FILES:
${Object.entries(files).map(([name, content]) => `--- ${name} ---\n${content}`).join('\n\n')}

Produce your review JSON.`;

    const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
    const response = await client.chat.completions.create({
      model: 'gpt-4o',
      max_tokens: 2048,
      messages: [
        { role: 'system', content: SYSTEM_PROMPT },
        { role: 'user', content: userPrompt },
      ],
    });

    const text = response.choices[0].message.content;
    let review;
    try {
      review = JSON.parse(text);
    } catch {
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        review = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error('Reviewer did not return valid JSON');
      }
    }

    // Validate required fields
    if (!review.overallVerdict || !review.items) {
      throw new Error('Reviewer output missing required fields');
    }

    res.json({
      stage: 'reviewer',
      review,
    });
  } catch (error) {
    console.error('Reviewer agent error:', error.message);
    res.status(500).json({ error: 'Reviewer agent failed', detail: error.message });
  }
};
